{"version":3,"file":"facepi.service.js","sourceRoot":"","sources":["../../src/utils/facepi.service.ts"],"names":[],"mappings":"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","sourcesContent":["\nimport {\n    FaceDetector,\n    FilesetResolver,\n    Detection,\n    FaceLandmarker,\n    FaceLandmarkerResult,\n    ImageSource\n  } from \"@mediapipe/tasks-vision\";\nimport { videoToBlob } from \"./camera.service\";\n\n\n export interface DetectionImg{\n    detection: Detection,\n    currentTarget: HTMLImageElement|HTMLVideoElement|HTMLCanvasElement,\n    blobImg: Blob,\n  }\n  \n\n\n  \n\n  \n/**\n * create a class \"FaceapiService\" with a constructor\n * \n*/\nexport class FaceapiService {\n\n    private faceDetector: FaceDetector;\n    private landmarksDetector: FaceLandmarker;\n\n\n    constructor(private readonly minDetectionConfidence = 0.6) {\n     \n    }\n\n    async initialize() {\n      this.initializefaceDetector(this.minDetectionConfidence);\n      this.initFaceLandmarkerDetector();\n      return this;\n    }\n\n\n\n    async initFaceLandmarkerDetector() {\n\n      const filesetResolver = await FilesetResolver.forVisionTasks(\n        \"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm\"\n      );\n      let runningMode: \"IMAGE\" | \"VIDEO\" = \"IMAGE\";\n      this.landmarksDetector = await FaceLandmarker.createFromOptions(filesetResolver, {\n        baseOptions: {\n          modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,\n          delegate: \"GPU\"\n        },\n        outputFaceBlendshapes: true,\n        runningMode,\n        numFaces: 1\n      });\n    }\n\n    // Initialize the object detector\n    async initializefaceDetector ( minDetectionConfidence ) {\n        const vision = await FilesetResolver.forVisionTasks(\n          \"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm\"\n        );\n        this.faceDetector = await FaceDetector.createFromOptions(vision, {\n          minSuppressionThreshold: 0.3,\n          minDetectionConfidence: minDetectionConfidence,\n          baseOptions: {\n            modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/1/blaze_face_short_range.tflite`,\n            delegate: \"GPU\"\n          },\n          runningMode: \"VIDEO\",\n        });\n      };\n\n    checkInitialized() {\n      if ( !this.landmarksDetector ) throw new Error(\"Aun no se cargo el model de face detection\")\n    }\n\n    async getFaceLandmarksFromBlob(blob:Blob):  Promise<FaceLandmarkerResult> {\n      this.checkInitialized()\n\n      let imag: ImageSource = await createImageBitmap(blob)\n      \n      return this.landmarksDetector.detect(imag)\n    }\n\n    async detectFace(el:HTMLVideoElement, timeStamp: DOMHighResTimeStamp):  Promise<DetectionImg> {\n\n      if ( el && this.faceDetector ) {\n         \n          const detection = this.faceDetector.detectForVideo(el, timeStamp).detections;\n\n          if ( !detection ) {\n            return null\n          }\n          \n          let detectionObj: Detection;\n\n          if ( detection.length == 1 ) {\n              detectionObj = detection[0]\n          }\n\n          if ( detection.length > 1 ) {\n              const sorted = detection.sort((a,b) => {\n                  return b.categories[0].score - a.categories[0].score\n              })\n              detectionObj = sorted[0]\n          }\n          \n          return await this.getDetectorImgFromDetection(el, detectionObj)\n        }\n\n        return null\n    }\n\n    async getDetectorImgFromDetection(el, detection: Detection): Promise<DetectionImg> {\n      // recortar canvas del el para que tenga el tamaño de la detección\n      if ( !detection || !detection.boundingBox) {\n        return null\n      }\n      \n      const blob = await videoToBlob(el, detection.boundingBox)\n        return {\n            detection: detection,\n            currentTarget: el,\n            blobImg: blob\n        }\n    }\n}\n\n\nexport const faceapiService = new FaceapiService()"]}